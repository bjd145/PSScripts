
$vm = New-AzureVMConfig -Name $vm_name -InstanceSize $cfg.azure.vm_size -ImageName $cfg.azure.vm_image |
    Add-AzureProvisioningConfig -Windows -Password $password -AdminUsername $cfg.azure.admin_user |
    Set-AzureSubnet -SubnetNames $cfg.azure.subnet | 
    Add-AzureDataDisk -ImportFrom -MediaLocation $storage_url -LUN 1 -DiskLabel "DATA"

New-AzureVM -VMs $vm -ServiceName $cloud_service -AffinityGroup $cfg.azure.vm_affinity  -VNetName $cfg.azure.vm_affinity

$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 100 -DiskLabel "disk 1" -LUN 0 
$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 100 -DiskLabel "disk 2" -LUN 1

$vm1 | Add-AzureEndpoint -Name 'web' -LocalPort 80 -PublicPort 80 -Protocol tcp
$vm1 | Add-AzureEndpoint -Name 'web' -LocalPort 80 -PublicPort 80 -Protocol tcp `
                         -LBSetName 'lbweb' -DefaultProbe

Set-AzureVMCustomScriptExtension -ContainerName scripts -StorageAccountName psmag -FileName user.ps1 -Run user.ps1 -VM $vm | Update-AzureVM -Verbose

$svcName = "myvmsvc123a1"
$vmName = "myvm1"
$img = "a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201305.01-en.us-127GB.vhd"
 
# Configure VM1
$vm1 = New-AzureVMConfig -Name $vmName -InstanceSize Small -ImageName $img
 
$vm1 | Add-AzureProvisioningConfig -Windows -AdminUsername 'iisadmin' `
                         -Password 'some@pass1' 
 
$vm1 | Set-AzureOSDisk -HostCaching ReadOnly
 
$vm1 | Add-AzureDataDisk -CreateNew -DiskSizeInGB 50 -DiskLabel "data1"  -LUN 0 
$vm1 | Add-AzureEndpoint -Name 'web' -Protocol tcp -LocalPort 80 -PublicPort 80

C:\PS> New-AzureVMConfig -Name "MyDomainVM" -InstanceSize Small -ImageName $img ` | Add-AzureProvisioningConfig -WindowsDomain –Password $Password -ResetPasswordOnFirstLogon -JoinDomain "contoso.com" -Domain "contoso" -DomainUserName "domainadminuser" -DomainPassword "domainPassword" -MachineObjectOU 'OU=AzureVMs,DC=contoso,DC=com' | New-AzureVM -ServiceName $svcName


# Create both VMs
New-AzureVM -ServiceName $svcName -Location 'West US' -VMs $vm1

Add-DnsServerResourceRecord -ZoneName "Contoso.com" -A -Name "Host34" -AllowUpdateAny -IPv4Address "10.17.1.34" -TimeToLive 01:00:00 -AgeRecord
Add-DnsServerResourceRecord -CName -Name "labhost34" -HostNameAlias "Host34.lab.contoso.com" -ZoneName "Contoso.com" -AllowUpdateAny  -TimeToLive 01:00:00

http://www.powershellmagazine.com/2014/04/30/understanding-azure-custom-script-extension/

Set-AzureVMExtension -ExtensionName CustomScriptExtension -VM $vm -Publisher Microsoft.Compute | Update-AzureVM -Verbose


$vm = New-AzureVMConfig -Name "example-1" -InstanceSize Small -ImageName "a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-R2-201407.01-en.us-127GB.vhd"  
$vm = Add-AzureProvisioningConfig -VM $vm -Windows -AdminUsername "admin_account" -Password "Bull_dog1" 
$vm = Set-AzureVMDSCExtension -VM $vm -ConfigurationArchive "IISInstall.ps1.zip" -ConfigurationName "IISInstall"  
New-AzureVM -VM $vm -Location "West US" -ServiceName "example-1-svc" -WaitForBoot

$vm = Set-AzureVMDSCExtension -VM $vm -ConfigurationArchive "IISInstall.ps1.zip" -ConfigurationName "IISInstall"